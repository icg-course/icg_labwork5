<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <title>Lab6</title>
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script src="http://www.x3dom.org/download/dev/x3dom-full.js"></script>
    <link rel="stylesheet" href="http://www.x3dom.org/download/dev/x3dom.css">
    <style>
       body {font-family: arial;font-family: arial;padding:0;margin:0;}
       X3D{left:0px; top:0px; width:100%; height: 450px;border: 0;}
    </style>
  </head>
  <body>
    <div style="text-align:center;width:100%;padding: 10px">
      <button id="start">Запустить JS анимацию</button>
    </div>
    <X3D id="x3d" xmlns="http://www.x3dom.org/x3dom">
     <Scene>
        <PositionChaser DEF='SphereCh' id='SphereCh' duration='1'></PositionChaser>
        <Transform onClick="move(event.hitPnt);" translation='0 -1 0'>
          <Shape>
            <Appearance>
              <Material diffuseColor='#046508'></Material>
            </Appearance>
            <Box size='10 0.1 10'></Box>
          </Shape>
        </Transform>
        <Transform id="trans" DEF='Sphere'>
          <Shape>
            <Appearance>
              <Material id='SphereMat' diffuseColor='1 0 1' emissiveColor='0 0 0'></Material>
            </Appearance>
            <Sphere></Sphere>
          </Shape>
        </Transform>
        <ROUTE fromNode='SphereCh' fromField='value_changed' toNode='Sphere' toField='set_translation'>
        </ROUTE>
      </Scene>
    </X3D>
  </body>
  <script>
    function move(point) {
      $('#SphereCh').attr('duration', '1');
      $('#SphereCh').attr('set_destination', point[0]+' '+parseFloat(point[1]+1)+' '+point[2]);
    }
    function animate({timing, draw, duration}) {
      let start = performance.now();
      requestAnimationFrame(function animate(time) {
        let timeFraction = (time - start) / duration;
        if (timeFraction > 1) timeFraction = 1;
        let progress = timing(timeFraction);
        draw(progress);
        if (timeFraction < 1) {
          requestAnimationFrame(animate);
        }
      });
    }
    function makeEaseOut(timing) {
      return function(timeFraction) {
        return 1 - timing(1 - timeFraction);
      }
    }
    function bounce(timeFraction) {
      for (var a = 0, b = 1, result; 1; a += b, b /= 2) {
        if (timeFraction >= (7 - 4 * a) / 11) {
          return -Math.pow((11 - 6 * a - 11 * timeFraction) / 4, 2) + Math.pow(b, 2)
        }
      }
    }
    var bounceEaseOut = makeEaseOut(bounce);

    $("#start").on("click", function() {
      $('#start').attr('disabled', 'disabled');
      var str = $('#SphereCh').attr('set_destination'),
          arr_point = [];
      if(!str) arr_point = [0, 0, 0];
      else {
        str = str.replace(',');
        arr_point = str.split(' ');
      }
      $('#SphereCh').attr('duration', '1');
      $('#SphereCh').attr('set_destination', arr_point[0]+' 3 '+arr_point[2]);
      setTimeout(function() {start(arr_point);}, 1000);
    });

    function start(arr_point){
      $('#SphereCh').attr('duration', '0.0001');
      animate({
        duration: 1000,
        timing: bounceEaseOut,
        draw: function(progress) {
          translation_y = 3 - progress * 3;
          $('#SphereCh').attr('set_destination', arr_point[0]+' '+translation_y+' '+arr_point[2]);
          if(translation_y == 0) $('#start').attr('disabled', false);
        }
      });
    }
  </script>
</html>
